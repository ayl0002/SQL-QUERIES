DECLARE @MIN DATE
DECLARE	@MAX DATE
DECLARE @DT_INT INT

SET @MIN = '2020-04-01'
SET @MAX = '2020-04-30'
SET @DT_INT = 20200401

SELECT DISTINCT A.LOAN_NBR,STATUS_CODE,STATUS_DESCRIPTION,[POOL_NAME]
INTO #MView
FROM Reverse_dw.[dbo].[RM_CHAMPION_MASTER_TBL_VW] (@MAX,@DT_INT) A
	

WHERE A.Loan_Nbr IN ('895383',
'893895',
'893329',
'893067',
'891991',
'1006244',
'891277',
'890704',
'1008600',
'891548',
'890753',
'890060',
'889754',
'889745',
'895442',
'895061',
'894871',
'893326',
'893243',
'890305',
'1014243',
'890052',
'890041',
'889628',
'1015420',
'889437',
'1016955',
'889847',
'889660',
'889510',
'889479',
'889311',
'1019517',
'889290',
'889272',
'889103',
'889386',
'889345',
'889315',
'889075',
'889028',
'888914',
'1022285',
'888895',
'889038',
'1022936',
'1022992',
'1023673',
'1023888',
'888796',
'888733',
'888687',
'888276',
'888737',
'888709',
'888703',
'888700',
'888419',
'1026039',
'888327',
'888257',
'887976',
'887453',
'887999',
'887703',
'887542',
'1027856',
'887499',
'887328',
'887289',
'887444',
'887420',
'887304',
'887221',
'887130',
'886823',
'886792',
'886736',
'1030048',
'886554',
'886530',
'1031013',
'1031103',
'886386',
'886985',
'886944',
'1031586',
'886842',
'886806',
'1032040',
'886715',
'886275',
'886128',
'886058',
'886048',
'886039',
'885912',
'1033648',
'886494',
'1033725',
'886360',
'1000897',
'886350',
'886340',
'886179',
'885876',
'885696',
'885667',
'885310',
'884718',
'884620',
'1000862',
'884612',
'885951',
'1000925',
'885860',
'884659',
'884616',
'1004139',
'1004418',
'1004520',
'884506',
'1005416',
'884188',
'1006773',
'884093',
'883663',
'882917',
'881604',
'1011730',
'882032',
'880220',
'1012640',
'880230',
'1012946',
'880087',
'880002',
'879053',
'878487',
'877733',
'1015138',
'1015219',
'877716',
'889672',
'889583',
'889434',
'889153',
'889003',
'1010320',
'888954',
'888784',
'888540',
'888266',
'887995',
'887693',
'1016054',
'887569',
'887553',
'887363',
'1017043',
'887148',
'886845',
'886843',
'886836',
'886826',
'1012636',
'886786',
'1013124',
'886702',
'886445',
'886405',
'886341',
'886185',
'886183',
'885788',
'885374',
'885321',
'885022',
'884631',
'880091',
'880031',
'879990',
'879973',
'879818',
'879509',
'879435',
'877213',
'1023124',
'876968',
'875496',
'875386',
'872467',
'874782',
'874720',
'1025241',
'872291',
'872175',
'871815',
'1026915',
'874241',
'874098',
'874071',
'870116',
'870051',
'870026',
'868074',
'1024548',
'867517',
'867535',
'866829',
'866913',
'866508',
'865820',
'865731',
'865764',
'865154',
'1029982',
'864914',
'1024984',
'865517',
'1025093',
'865464',
'865295',
'864817',
'864140',
'864298',
'863695',
'863051',
'862509',
'861749',
'860747',
'860478',
'860187',
'1032276',
'877615',
'875379',
'874526',
'872852',
'871900',
'869916',
'1027603',
'869603',
'869149',
'1028324',
'862747',
'861234',
'860120',
'1033037',
'859630',
'855802',
'854899',
'853888',
'852582',
'853820',
'853361',
'852015',
'851980',
'851627',
'850493',
'1029482',
'852410',
'850890',
'850730',
'850041',
'850093',
'849974',
'849878',
'1031045',
'849854',
'849839',
'849776',
'849759',
'849725',
'849367',
'849362',
'849299',
'849265',
'849503',
'849485',
'849193',
'849116',
'849036',
'1037544',
'1037601',
'848702',
'848686',
'848606',
'848516',
'847857',
'847832',
'848571',
'848466',
'848459',
'848420',
'848410',
'1040170',
'1040260',
'847781',
'847778',
'847708',
'847674',
'847619',
'847583',
'847633',
'847192',
'846915',
'847106',
'846774',
'846711',
'846378',
'846188',
'846081',
'846062',
'845945',
'845928',
'1045422',
'845914',
'846239',
'846091',
'845983',
'845957',
'1046834',
'845838',
'845671',
'1047971',
'845634',
'845489',
'1050010',
'1050365',
'845417',
'1052004',
'845380',
'845311',
'845165',
'845467',
'845348',
'845047',
'844799',
'845030',
'844984',
'844975',
'844901',
'1053853',
'844812',
'844637',
'858787',
'858615',
'856553',
'1054346',
'853502',
'852812',
'1054514',
'1033771',
'852549',
'851820',
'851472',
'851282',
'850619',
'850472',
'849997',
'849864',
'849837',
'849718',
'849437',
'849377',
'1034811',
'849280',
'849103',
'848762',
'848467',
'848276',
'848258',
'848240',
'1036309',
'847751',
'847379',
'847284',
'846970',
'846889',
'846581',
'846404',
'846234',
'846035',
'1035638',
'845964',
'845819',
'1035910',
'845453',
'845450',
'1038093',
'844925',
'844914',
'844414',
'844124',
'844058',
'844635',
'1040074',
'1036067',
'844601',
'1036426',
'844529',
'844476',
'844347',
'844048',
'1037840',
'844014',
'844038',
'843987',
'1040895',
'843983',
'843892',
'843857',
'843692',
'843735',
'1042395',
'843668',
'1038278',
'1038427',
'843620',
'843644',
'843601',
'843353',
'843159',
'843120',
'1042421',
'1042950',
'1043203',
'843027',
'842669',
'842090',
'1044266',
'842751',
'842446',
'842405',
'1040468',
'1040509',
'842308',
'1040680',
'842096',
'841821',
'841751',
'1045187',
'840575',
'1046435',
'840521',
'841685',
'841241',
'1047383',
'838605',
'838534',
'1041170',
'837891',
'840514',
'840462',
'1042988',
'839968',
'839695',
'1043787',
'839690',
'768286',
'1048064',
'1048388',
'839344',
'839098',
'838694',
'766108',
'1049317',
'838131',
'768664',
'768184',
'1044314',
'768081',
'1045169',
'1045347',
'768001',
'766531',
'762921',
'1046476',
'764950',
'764922',
'764479',
'763611',
'762814',
'761862',
'1048137',
'761318',
'762258',
'761519',
'844516',
'844415',
'844304',
'844277',
'844103',
'843948',
'843900',
'843802',
'843599',
'1049542',
'843247',
'1049854',
'843169',
'842863',
'842690',
'842657',
'842154',
'841639',
'1053976',
'841550',
'841363',
'841207',
'1054873',
'841178',
'841121',
'1050645',
'840951',
'840939',
'840814',
'840023',
'1052321',
'1053449',
'839961',
'839386',
'839140',
'839069',
'838786',
'1054447',
'767057',
'766028',
'765684',
'1055311',
'764944',
'764320',
'762529',
'762496',
'1056337',
'761594',
'761036',
'761194',
'760362',
'759524',
'1058230',
'759419',
'758599',
'758128',
'757120',
'758556',
'1059701',
'1060427',
'758143',
'757441',
'1061098',
'757039',
'1061408',
'1061409',
'756599',
'756080',
'756041',
'1061733',
'756543',
'756538',
'1062415',
'755700',
'754880',
'1064225',
'755520',
'754953',
'752795',
'751023',
'1066080',
'1066411',
'1066790',
'751050',
'1069405',
'750245',
'1070567',
'750678',
'750399',
'750210',
'749057',
'748762',
'748293',
'747635',
'746639',
'745936',
'745821',
'759788',
'759565',
'1056377',
'759157',
'756523',
'756382',
'755422',
'754785',
'754563',
'752803',
'752716',
'751862',
'750608',
'747754',
'1057860',
'747566',
'1057564',
'746275',
'746060',
'744619',
'744519',
'1058592',
'744467',
'743992',
'1057974',
'743127',
'742816',
'742307',
'742002',
'742593',
'741876',
'741477',
'741115',
'741867',
'1059729',
'741643',
'741425',
'740546',
'1060068',
'386219',
'741098',
'1061182',
'740116',
'2948032',
'1060333',
'2861734',
'403527',
'357988',
'1061356',
'2874637',
'2862483',
'1061265',
'1061590',
'2859592',
'2851479',
'1061865',
'2842182',
'1062384',
'2848849',
'1062543',
'2843149',
'1062692',
'1063072',
'1063159',
'2835708',
'2829390',
'2823997',
'2823054',
'1064890',
'2822451',
'1063688',
'2827720',
'1064398',
'2816204',
'2816033',
'2815920',
'2812994',
'1065312',
'2819537',
'2813597',
'2813542',
'2805508',
'2805461',
'1067623',
'2813063',
'2810958',
'2808420',
'745543',
'744745',
'1066130',
'1066225',
'744742',
'741686',
'1066663',
'741421',
'1067172',
'740815',
'1069039',
'740418',
'342162',
'341693',
'316554',
'316455',
'2947952',
'2866023',
'2851311',
'2849997',
'1067725',
'2839780',
'2832965',
'2824987',
'2821940',
'2816088',
'2812006',
'2809604',
'2808750',
'1071464',
'2806304',
'2804530',
'2803993',
'2803744',
'2807522',
'2807145',
'2806086',
'2802812',
'1070672',
'2800364',
'1071250',
'2797508',
'2797165',
'2797109',
'2798565',
'1072297',
'2798280',
'2798031',
'2796211',
'2795993',
'2795880',
'2794889',
'1073452',
'2793742',
'2791831',
'2790647',
'2790362',
'2789483',
'1074050',
'2797154',
'2795813',
'2791568',
'2786743',
'2786195',
'1074551',
'2785968',
'2785924',
'1075289',
'2785559',
'2790011',
'2788040',
'2787389',
'2785957',
'1078685',
'2784558',
'2783498',
'1079854',
'2782909',
'2782885',
'2782830',
'2785218',
'2785194',
'2784547',
'1081713',
'2783158',
'2782442',
'2781884',
'2781533',
'2780280',
'1084722',
'2782783',
'2782293',
'2781496',
'2781010',
'2779891',
'2779846',
'2780144',
'2779390',
'2777467',
'2777105',
'2776865',
'2776433',
'2776342',
'2778549',
'2778468',
'2777899',
'2777526',
'2775933',
'1090725',
'2775502',
'2774909',
'2773134',
'2772941',
'2776752',
'2776650',
'2776228',
'1150735',
'2774896',
'2774408',
'1151206',
'1151439',
'1151510',
'2771666',
'2769797',
'2773555',
'2773407',
'2772714',
'1152323',
'1152336',
'2771962',
'1152495',
'2769899',
'2769296',
'2766829',
'2766749',
'1152787',
'2765511',
'1152909',
'1152939',
'2763973',
'1153022',
'2762530',
'2766000',
'2764484',
'2762938',
'2762379',
'2803016',
'1153426',
'2801365',
'1153563',
'2800104',
'2798337',
'1153780',
'2796870',
'2795824',
'2795744',
'1154096',
'1154387',
'1154414',
'2795367',
'2795107',
'2794173',
'2793811',
'2792901',
'1155214',
'2792353',
'2791535',
'2791136',
'2790705',
'2788142',
'2788095',
'2787620',
'2786231',
'2786151',
'2115400',
'2784160',
'2784002',
'2118492',
'2783853',
'2783831',
'2783078',
'2781076',
'2779573',
'2779265',
'2776536',
'2775147',
'2773817',
'1079474',
'2771860',
'2771848',
'2770654',
'2770051',
'1079026',
'1079143',
'2769946',
'1079834',
'2769003',
'2767875',
'2767410',
'2766636',
'2765782',
'2763494',
'2761390',
'2759784',
'2758976',
'2758501',
'1084405',
'2758044',
'2757964',
'1081152',
'1081326',
'2756417',
'2756348',
'2756202',
'2755940',
'1084010',
'2755655',
'1085576',
'2755611',
'2759067',
'2754712',
'2754391',
'2751274',
'2750638',
'2750057',
'2747905',
'2747836',
'1085538',
'1085558',
'2747062',
'2746185',
'2740602',
'2754847',
'1086776',
'2753959',
'2752106',
'2751434',
'2750763',
'2746993',
'2742067',
'2736504',
'2732953',
'2740975',
'2740383',
'2740189',
'2740043',
'1087790',
'2739529',
'1088224',
'2736003',
'2732292',
'2731246',
'2730336',
'2735923',
'2732145',
'2730109',
'2729709',
'2727284',
'2727273',
'2726682',
'2728138',
'1150866',
'2726261',
'2725124',
'2726363',
'1150568',
'2723805',
'2723612',
'2718853',
'2717293',
'2716679',
'1151194',
'2716076',
'1151228',
'2715894',
'1151519',
'1151577',
'2715554',
'1151655',
'2720857',
'2720049',
'2719240',
'1151709',
'2716920',
'2716613',
'1152073',
'2716500',
'1152160',
'2715996',
'2711538',
'1152000',
'2707758',
'2707440',
'2706702',
'2705949',
'2709954',
'2709282',
'1152856',
'1153052',
'2707177',
'1152684',
'2707100',
'2761697',
'2760128',
'2759795',
'2759728',
'2759615',
'1153106',
'1153062',
'2759136',
'2759078',
'2758419',
'2757327',
'2756747',
'2755597',
'1153533',
'2755438',
'1153554',
'2753948',
'2752856',
'1153224',
'2752413',
'2751047',
'1153390',
'1153435',
'2749428',
'2744343',
'2739870',
'2738857',
'2737059',
'1153681',
'2734773',
'2734205',
'2733044',
'1153880',
'2732635',
'2732485',
'1153762',
'2731769',
'2731736',
'1154045',
'2731656',
'2731304',
'2729925',
'1154404',
'1153904',
'2729527',
'2728183',
'1154191',
'1154617',
'2726089',
'1154756',
'2725807',
'2718580',
'2716964',
'1154719',
'2716953',
'2716919',
'1155169',
'2716782',
'2104839',
'2716522',
'2713186',
'2711765',
'2710651',
'2709066',
'2115718',
'2708418',
'2707703',
'2116263',
'2117402',
'2704813',
'2704755',
'2700181',
'2706289',
'2705814',
'2705596',
'2101518',
'2704868',
'2704506',
'2704209',
'2703355',
'2700034',
'2698381',
'2697006',
'2695969',
'2695787',
'2703195',
'2703026',
'2698449',
'2698007',
'2124775',
'2697541',
'2696891',
'2127448',
'2694467',
'2693193',
'2692819',
'2691124',
'2139545',
'2691044',
'2690463',
'2696686',
'2695618',
'2695491',
'2694365',
'2693763',
'2689574',
'2159777',
'2689222',
'2686401',
'2686387',
'2163728',
'2164707',
'2685193',
'2693035',
'2692170',
'2691113',
'2685002',
'2684911',
'2684535',
'2689949',
'2689858',
'2689723',
'2177860',
'2683431',
'2682372',
'2682032',
'2681941',
'2681918',
'2203602',
'2689379',
'2687446',
'2687402',
'2687355',
'2686899',
'2686445',
'2681565',
'2681532',
'2681188',
'2681053',
'2680779',
'2685536',
'2684966',
'2684498',
'2682555',
'2255228',
'2682269',
'2682112',
'2680768',
'2680600',
'2266129',
'2680575',
'2680201',
'2680176',
'2680110',
'2682009',
'2681996',
'2275095',
'2681805',
'2681770',
'2681714',
'2681440',
'2681371',
'2680096',
'2680007',
'2679787',
'2678296',
'2677729',
'2677160',
'2681304',
'2681075',
'2681020',
'2680882',
'2680848',
'2680713',
'2680461',
'2680416',
'2680198',
'2319133',
'2679867',
'2706369',
'2703479',
'2701273',
'2698520',
'2697905',
'2696469',
'2695195',
'2694070',
'2693672',
'2692637',
'2690680',
'2688210',
'2686172',
'2685466',
'2684181',
'2683408',
'2683328',
'2682418',
'2682407',
'2682076',
'2681930',
'2681816',
'2121088',
'2681601',
'2681359',
'2681326',
'2681257',
'2681224',
'2680962',
'2127233',
'2680314',
'2679754',
'2679527',
'2679333',
'2676615',
'2676591',
'2675965',
'2675921',
'2147191',
'2678786',
'2677967',
'2677707',
'2676897',
'2676693',
'2676604',
'2658418',
'2676045',
'2675362',
'2675179',
'2631176',
'2650604',
'2625931',
'2624792',
'2157866',
'2621813',
'2608202',
'2165321',
'2602741',
'2599110',
'2590439',
'2586148',
'2566337',
'2560707',
'2570491',
'2537342',
'2533634',
'2530788',
'2166468',
'2167573',
'2559305',
'2525462',
'2510454',
'2523518',
'2498334',
'2491315',
'2497140',
'2678183',
'2678070',
'2677912',
'2677308',
'2677295',
'2676933',
'2181070',
'2676432',
'2676227',
'2676090',
'2675351',
'2675340',
'2635078',
'2631677',
'2629252',
'2625214',
'2620093',
'2573007',
'2572211',
'2566097',
'2550215',
'2508405',
'2214898',
'2215742',
'2196738',
'2501501',
'2495763',
'2494498',
'2484225',
'2454640',
'2450270',
'2448173',
'2451750',
'2432084',
'2430059',
'2428420',
'2416518',
'2231376',
'2399971',
'2393726',
'2385839',
'2241447',
'2363913',
'2362240',
'2352501',
'2347171',
'2454161',
'2231979',
'2449584',
'2428669',
'2398925',
'2393076',
'2383611',
'2367837',
'2243325',
'2366119',
'2349981',
'2337453',
'2254626',
'2333266',
'2328668',
'2267379',
'2316904',
'2312409',
'2291825',
'2279088',
'2272811',
'2276735')

--
SELECT A.*,[HUD_PRELIM_TTL_APRVL_DT],[HUD_PRELIM_TTL_DNY_DT],DT_SBMT_TO_HUD
INTO #BASE
FROM #MView A

	LEFT JOIN (SELECT FNL.LOAN_NBR,[HUD_PRELIM_TTL_APRVL_DT],[HUD_PRELIM_TTL_DNY_DT],FNL.EFF_DTTM FROM Reverse_DW.[dbo].[HUD_ASGN_HUD_STS] FNL
				LEFT JOIN (SELECT Loan_Nbr,MAX(EFF_DTTM) AS 'EFF_DTTM' FROM Reverse_DW.[dbo].[HUD_ASGN_HUD_STS] WHERE CAST(EFF_DTTM AS DATE) <= CAST(@MAX AS DATE) GROUP BY LOAN_NBR) FNLA
				ON FNL.LOAN_NBR = FNLA.LOAN_NBR 
				WHERE FNL.EFF_DTTM = FNLA.EFF_DTTM) B
ON A.Loan_Nbr = B.Loan_Nbr
	LEFT JOIN (SELECT LOAN_NBR, MAX([DT_SBMT_TO_HUD]) AS 'DT_SBMT_TO_HUD' FROM Reverse_DW.Dbo.HUD_ASSGN_DT_SBMT_RESBMT WHERE [DT_SBMT_TO_HUD] IS NOT NULL AND CAST([DT_SBMT_TO_HUD] AS DATE) BETWEEN CAST(@MIN AS DATE) AND CAST(@MAX AS DATE) GROUP BY LOAN_NBR) C
ON A.Loan_Nbr = C.Loan_Nbr

--Final--
SELECT A.LOAN_NBR,STATUS_CODE,STATUS_DESCRIPTION,Pool_name,--B.DT_SBMT_TO_HUD AS 'Min Submitted',
D.DT_SBMT_TO_HUD AS 'Max Submitted',Approval_DT,CAST(Denial_Dt AS DATE) AS 'Denial_Dt',
CASE
	WHEN STATUS_CODE = 72 THEN 'Resolved'
	WHEN STATUS_CODE = 0  AND D.DT_SBMT_TO_HUD IS NOT NULL THEN 'Resolved'
	WHEN STATUS_CODE <> 0 THEN 'Resolved'
	ELSE 'Pending'
END AS 'Final Status'
,CASE
	WHEN D.DT_SBMT_TO_HUD <= Denial_Dt THEN 'HUD Denied'
	WHEN Approval_DT <= Denial_Dt THEN 'HUD Denied'
	WHEN Approval_DT IS NOT NULL THEN 'HUD Approved'
	WHEN D.DT_SBMT_TO_HUD IS NOT NULL THEN 'Submitted to HUD'
	WHEN D.DT_SBMT_TO_HUD IS NULL THEN 'Not Submitted'
	ELSE 'Error'
END AS 'HUD Status'
INTO #BASE2
FROM
#BASE A
/*
LEFT JOIN (SELECT Loan_nbr,min([DT_SBMT_TO_HUD]) AS 'DT_SBMT_TO_HUD' FROM Reverse_DW.Dbo.HUD_ASSGN_DT_SBMT_RESBMT 
			WHERE CAST([DT_SBMT_TO_HUD] AS DATE) BETWEEN CAST(@MIN AS DATE) 
			AND CAST(@MAX AS DATE) GROUP BY LOAN_NBR) B
		ON A.LOAN_NBR = B.LOAN_NBR*/
LEFT JOIN (SELECT Loan_nbr,max([HUD_PRELIM_TTL_DNY_DT]) AS 'Denial_Dt' FROM #BASE WHERE [HUD_PRELIM_TTL_DNY_DT] IS NOT NULL AND CAST([HUD_PRELIM_TTL_DNY_DT] AS DATE)
			<= CAST(@MAX AS DATE) GROUP BY LOAN_NBR) C
		ON A.LOAN_NBR = C.LOAN_NBR
LEFT JOIN (SELECT Loan_nbr,DT_SBMT_TO_HUD FROM #BASE) D
		ON A.LOAN_NBR = D.LOAN_NBR
LEFT JOIN (SELECT Loan_nbr,max([HUD_PRELIM_TTL_APRVL_DT]) AS 'Approval_DT' FROM #BASE WHERE [HUD_PRELIM_TTL_APRVL_DT] IS NOT NULL AND CAST([HUD_PRELIM_TTL_APRVL_DT] AS DATE)
			<= CAST(@MAX AS DATE) GROUP BY LOAN_NBR) E
		ON A.LOAN_NBR = E.LOAN_NBR

--EXCP_DW PULL--
SELECT A.*,EXCP_ID,[DOC_DESC],[ISSU_DESC],[EXCP_STS_DESC],[WRK_GRP_DESC],EFF_DTTM 
INTO #EXCP
FROM #BASE2 A
LEFT JOIN (SELECT * FROM REVERSE_DW.[dbo].[HUD_ASGN_EXCP_EDW] WHERE CAST(EFF_DTTM AS DATE) <= CAST(@MAX AS DATE)) B
ON A.LOAN_NBR = B.Loan_Nbr

--Active Excp--
SELECT A.*,Open_DTTM,Close_DTTM
INTO #EXCP_FINAL
FROM #EXCP A
LEFT JOIN (SELECT EXCP_ID,MAX(EFF_DTTM) AS 'Open_DTTM' FROM #EXCP WHERE ([EXCP_STS_DESC] NOT IN ('RESOLVED','CLOSED','NOT VALID','CLOSED WITH VENDOR','Resolved by ML') OR [EXCP_STS_DESC] = 'Incurable') GROUP BY EXCP_ID) B
	ON A.EXCP_ID  = B.EXCP_ID
LEFT JOIN (SELECT EXCP_ID,MAX(EFF_DTTM) AS 'Close_DTTM' FROM #EXCP WHERE [EXCP_STS_DESC] IN ('RESOLVED','CLOSED','NOT VALID','CLOSED WITH VENDOR','Resolved by ML') GROUP BY EXCP_ID) C
	ON A.EXCP_ID  = C.EXCP_ID

WHERE Open_DTTM > (ISNULL(Close_DTTM,1/1/1900)) AND Open_DTTM = EFF_DTTM

--Final Exception Level--
SELECT BASE.LOAN_NBR,BASE.POOL_NAME,BASE.STATUS_CODE,BASE.STATUS_DESCRIPTION,BASE.[Max Submitted],BASE.Approval_DT,BASE.Denial_Dt,	BASE.[Final Status],BASE.[HUD Status],ISNULL(HACG_Count.HACG_Count,0) AS 'HACG_Count'
,ISNULL(Cura_Count.Cura_Count,0) AS 'Cura_Count'
,ISNULL(SM_Count.SM_Count,0) AS 'SM_Count'
,ISNULL(Incur_Count.Incur_Count,0) AS 'Incur_Count'
,EXCP.EXCP_ID,	EXCP.DOC_DESC,	EXCP.ISSU_DESC,	EXCP.EXCP_STS_DESC,	EXCP.WRK_GRP_DESC,	EXCP.EFF_DTTM,	EXCP.Open_DTTM,	EXCP.Close_DTTM
FROM #BASE2 BASE
LEFT JOIN #EXCP_FINAL EXCP
ON BASE.LOAN_NBR = EXCP.LOAN_NBR
LEFT JOIN (SELECT A.Loan_Nbr,MAX(HACG_Count) AS 'HACG_Count' FROM #EXCP_FINAL A
				INNER JOIN (SELECT *,ROW_NUMBER() OVER (Partition by Loan_Nbr Order by DOC_DESC) AS 'HACG_Count' FROM #EXCP_FINAL WHERE isnull([WRK_GRP_DESC],'No Group') NOT IN ('LandTran','Curative') AND [DOC_DESC] <> 'Loss Draft' AND [ISSU_DESC] <> 'Forced Placed Insurance' AND [EXCP_STS_DESC] <> 'Incurable') B
				ON A.EXCP_ID = B.EXCP_ID GROUP BY A.LOAN_NBR) HACG_Count
			ON BASE.Loan_Nbr = HACG_Count.Loan_Nbr
LEFT JOIN (SELECT A.Loan_Nbr,MAX(CURA_Count) AS 'Cura_Count' FROM #EXCP_FINAL A
				INNER JOIN (SELECT *,ROW_NUMBER() OVER (Partition by Loan_Nbr Order by DOC_DESC) AS 'CURA_Count' FROM #EXCP_FINAL WHERE isnull([WRK_GRP_DESC],'No Group') IN ('LandTran','Curative') AND [DOC_DESC] <> 'Loss Draft' AND [ISSU_DESC] <> 'Forced Placed Insurance' AND [EXCP_STS_DESC] <> 'Incurable') B
				ON A.EXCP_ID = B.EXCP_ID GROUP BY A.LOAN_NBR) CURA_Count
			ON BASE.Loan_Nbr = CURA_Count.Loan_Nbr
LEFT JOIN (SELECT A.Loan_Nbr,MAX(SM_Count) AS 'SM_Count' FROM #EXCP_FINAL A
				INNER JOIN (SELECT *,ROW_NUMBER() OVER (Partition by Loan_Nbr Order by DOC_DESC) AS 'SM_Count' FROM #EXCP_FINAL WHERE [DOC_DESC] = 'Loss Draft' OR [ISSU_DESC] = 'Forced Placed Insurance') B
				ON A.EXCP_ID = B.EXCP_ID GROUP BY A.LOAN_NBR) SM_Count
			ON BASE.Loan_Nbr = SM_Count.Loan_Nbr
LEFT JOIN (SELECT A.Loan_Nbr,MAX(Incur_Count) AS 'Incur_Count' FROM #EXCP_FINAL A
				INNER JOIN (SELECT *,ROW_NUMBER() OVER (Partition by Loan_Nbr Order by DOC_DESC) AS 'Incur_Count' FROM #EXCP_FINAL WHERE [EXCP_STS_DESC] = 'Incurable') B
				ON A.EXCP_ID = B.EXCP_ID GROUP BY A.LOAN_NBR) Incur_Count
			ON BASE.Loan_Nbr = Incur_Count.Loan_Nbr

--Final Loan Level--
SELECT BASE.LOAN_NBR,BASE.STATUS_CODE,BASE.POOL_NAME,BASE.STATUS_DESCRIPTION,BASE.[Max Submitted],BASE.Approval_DT,BASE.Denial_Dt,	BASE.[Final Status],BASE.[HUD Status],ISNULL(HACG_Count.HACG_Count,0) AS 'HACG_Count'
,ISNULL(Cura_Count.Cura_Count,0) AS 'Cura_Count'
,ISNULL(SM_Count.SM_Count,0) AS 'SM_Count'
,ISNULL(Incur_Count.Incur_Count,0) AS 'Incur_Count'
FROM #BASE2 BASE
LEFT JOIN (SELECT A.Loan_Nbr,MAX(HACG_Count) AS 'HACG_Count' FROM #EXCP_FINAL A
				INNER JOIN (SELECT *,ROW_NUMBER() OVER (Partition by Loan_Nbr Order by DOC_DESC) AS 'HACG_Count' FROM #EXCP_FINAL WHERE isnull([WRK_GRP_DESC],'No Group') NOT IN ('LandTran','Curative') AND [DOC_DESC] <> 'Loss Draft' AND [ISSU_DESC] <> 'Forced Placed Insurance' AND [EXCP_STS_DESC] <> 'Incurable') B
				ON A.EXCP_ID = B.EXCP_ID GROUP BY A.LOAN_NBR) HACG_Count
			ON BASE.Loan_Nbr = HACG_Count.Loan_Nbr
LEFT JOIN (SELECT A.Loan_Nbr,MAX(CURA_Count) AS 'Cura_Count' FROM #EXCP_FINAL A
				INNER JOIN (SELECT *,ROW_NUMBER() OVER (Partition by Loan_Nbr Order by DOC_DESC) AS 'CURA_Count' FROM #EXCP_FINAL WHERE isnull([WRK_GRP_DESC],'No Group') IN ('LandTran','Curative') AND [DOC_DESC] <> 'Loss Draft' AND [ISSU_DESC] <> 'Forced Placed Insurance' AND [EXCP_STS_DESC] <> 'Incurable') B
				ON A.EXCP_ID = B.EXCP_ID GROUP BY A.LOAN_NBR) CURA_Count
			ON BASE.Loan_Nbr = CURA_Count.Loan_Nbr
LEFT JOIN (SELECT A.Loan_Nbr,MAX(SM_Count) AS 'SM_Count' FROM #EXCP_FINAL A
				INNER JOIN (SELECT *,ROW_NUMBER() OVER (Partition by Loan_Nbr Order by DOC_DESC) AS 'SM_Count' FROM #EXCP_FINAL WHERE [DOC_DESC] = 'Loss Draft' OR [ISSU_DESC] = 'Forced Placed Insurance') B
				ON A.EXCP_ID = B.EXCP_ID GROUP BY A.LOAN_NBR) SM_Count
			ON BASE.Loan_Nbr = SM_Count.Loan_Nbr
LEFT JOIN (SELECT A.Loan_Nbr,MAX(Incur_Count) AS 'Incur_Count' FROM #EXCP_FINAL A
				INNER JOIN (SELECT *,ROW_NUMBER() OVER (Partition by Loan_Nbr Order by DOC_DESC) AS 'Incur_Count' FROM #EXCP_FINAL WHERE [EXCP_STS_DESC] = 'Incurable') B
				ON A.EXCP_ID = B.EXCP_ID GROUP BY A.LOAN_NBR) Incur_Count
			ON BASE.Loan_Nbr = Incur_Count.Loan_Nbr

DROP TABLE #MView,#BASE,#BASE2,#EXCP,#EXCP_FINAL