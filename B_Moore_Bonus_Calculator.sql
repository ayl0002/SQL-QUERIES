DECLARE	@BOM DATE
DECLARE	@EOM DATE
DECLARE @EXCP NVARCHAR(MAX)

SET @BOM = '2020-01-01'
SET @EOM = '2020-01-31'
SET @EXCP = ' '
SELECT DISTINCT A.Loan_Nbr,Open_Excp,Reopen_Excp,Close_Excp,New_Excp
,CASE 
WHEN New_Excp IS NOT NULL AND ISNULL(CLOSE_Excp,'1/1/1900') < New_Excp THEN 'Excp Open @ Roll'
WHEN Reopen_Excp IS NOT NULL AND ISNULL(Reopen_Excp,'1/1/1900') < ISNULL(Open_Excp,'1/1/1900') AND ISNULL(Reopen_Excp,'1/1/1900') > ISNULL(CLOSE_Excp,'1/1/1900')  THEN 'Excp ReOpened at Roll'
WHEN Reopen_Excp IS NOT NULL AND ISNULL(Reopen_Excp,'1/1/1900') < ISNULL(CLOSE_Excp,'1/1/1900') THEN 'Excp Closed & ReOpened at Roll'
WHEN New_Excp IS NOT NULL AND ISNULL(CLOSE_Excp,'1/1/1900') >= New_Excp THEN 'Excp Open & Closed at Roll'
WHEN ISNULL(Open_Excp,'1/1/1900') > ISNULL(CLOSE_Excp,'1/1/1900') THEN 'Excp Open before Roll'
WHEN ISNULL(Close_Excp,'1/1/1900') >= ISNULL(Open_Excp,'1/1/1900') THEN 'Excp Closed'
WHEN Open_Excp IS NULL AND Close_Excp IS NULL THEN 'No Excp'
ELSE 'Error'
END AS 'EXCP'

INTO #FINAL

FROM  Reverse_DW.[dbo].[RM_CHAMPION_MASTER_TBL_CURR_VW] A

LEFT JOIN (SELECT Loan_Nbr,MAX(Eff_DTTM) AS 'Open_Excp' FROM Reverse_DW.[dbo].[HUD_ASGN_EXCP_EDW] WHERE (DOC_DESC IN ('Loss Draft') OR ISSU_DESC IN ('Forced Placed Insurance')) AND Excp_Sts_Desc NOT IN ('RESOLVED','CLOSED','NOT VALID','CLOSED WITH VENDOR','INCURABLE') AND CAST(Eff_DTTM AS DATE) BETWEEN CAST(@BOM AS DATE) AND CAST(@EOM AS DATE) GROUP BY LOAN_NBR) B
	ON CAST(A.Loan_Nbr AS NVARCHAR) = B.Loan_Nbr
LEFT JOIN (SELECT Loan_Nbr,MAX(Eff_DTTM) AS 'Close_Excp' FROM Reverse_DW.[dbo].[HUD_ASGN_EXCP_EDW] WHERE (DOC_DESC IN ('Loss Draft') OR ISSU_DESC IN ('Forced Placed Insurance')) AND Excp_Sts_Desc IN ('RESOLVED','CLOSED','NOT VALID','CLOSED WITH VENDOR','INCURABLE') AND CAST(Eff_DTTM AS DATE) BETWEEN CAST(@BOM AS DATE) AND CAST(@EOM AS DATE) GROUP BY LOAN_NBR) C
	ON A.Loan_Nbr = C.Loan_Nbr

/*
LEFT JOIN (SELECT Loan_Nbr,EXCP_RQST_DTTM AS 'New_Excp' FROM Reverse_DW.[dbo].[HUD_ASGN_EXCP_EDW] WHERE (DOC_DESC IN ('Loss Draft') OR ISSU_DESC IN ('Forced Placed Insurance')) AND Excp_Sts_Desc NOT IN ('RESOLVED','CLOSED','NOT VALID','CLOSED WITH VENDOR','INCURABLE') AND CAST(EXCP_RQST_DTTM AS DATE) BETWEEN CAST(@BOM AS DATE) AND CAST(@EOM AS DATE)) D
	ON A.Loan_Nbr = D.Loan_Nbr


--By Issue--
LEFT JOIN (SELECT Loan_Nbr,MAX(Eff_DTTM) AS 'Open_Excp' FROM Reverse_DW.[dbo].[HUD_ASGN_EXCP_EDW] WHERE DOC_DESC IN (@ISSUE) AND Excp_Sts_Desc NOT IN ('RESOLVED','CLOSED','NOT VALID','CLOSED WITH VENDOR','INCURABLE') AND CAST(Eff_DTTM AS DATE) <= CAST(@EOM AS DATE) GROUP BY LOAN_NBR) B
	ON CAST(A.Loan_Nbr AS NVARCHAR) = B.Loan_Nbr
LEFT JOIN (SELECT Loan_Nbr,MAX(Eff_DTTM) AS 'Close_Excp' FROM Reverse_DW.[dbo].[HUD_ASGN_EXCP_EDW] WHERE DOC_DESC IN (@ISSUE) AND Excp_Sts_Desc IN ('RESOLVED','CLOSED','NOT VALID','CLOSED WITH VENDOR','INCURABLE') AND CAST(Eff_DTTM AS DATE) BETWEEN CAST(@BOM AS DATE) AND CAST(@EOM AS DATE) GROUP BY LOAN_NBR) C
	ON A.Loan_Nbr = C.Loan_Nbr
LEFT JOIN (SELECT Loan_Nbr,EXCP_RQST_DTTM AS 'New_Excp' FROM Reverse_DW.[dbo].[HUD_ASGN_EXCP_EDW] WHERE DOC_DESC IN (@ISSUE) AND Excp_Sts_Desc NOT IN ('RESOLVED','CLOSED','NOT VALID','CLOSED WITH VENDOR','INCURABLE') AND CAST(EXCP_RQST_DTTM AS DATE) BETWEEN CAST(@BOM AS DATE) AND CAST(@EOM AS DATE)) D
	ON A.Loan_Nbr = D.Loan_Nbr

LEFT JOIN (SELECT Loan_Nbr,MAX(END_DTTM) AS 'Reopen_Excp' FROM Reverse_DW.[dbo].[HUD_ASGN_EXCP_EDW] WHERE DOC_DESC IN (@EXCP) AND Excp_Sts_Desc IN ('RESOLVED','CLOSED','NOT VALID','CLOSED WITH VENDOR','INCURABLE') AND CURR_IND IN ('N') GROUP BY Loan_Nbr) E
	ON A.Loan_Nbr = D.Loan_Nbr

LEFT JOIN (SELECT Loan_Nbr,MAX(END_DTTM) AS 'Reopen_Excp' FROM Reverse_DW.[dbo].[HUD_ASGN_EXCP_EDW] WHERE DOC_DESC IN (@ISSUE) AND Excp_Sts_Desc IN ('RESOLVED','CLOSED','NOT VALID','CLOSED WITH VENDOR','INCURABLE') AND CURR_IND IN ('N') GROUP BY Loan_Nbr) E
	ON A.Loan_Nbr = D.Loan_Nbr
*/

WHERE A.Loan_Nbr IN ('2415334',
'2468817',
'747566',
'756837',
'861619',
'864297',
'878081',
'879228',
'1021383',
'1038513',
'1052474',
'1083804',
'2314628',
'2341961',
'2403169',
'2416585',
'2455311',
'750126',
'756379',
'837786',
'864526',
'878329',
'1031021',
'1057230',
'1087708',
'1153677',
'2342427',
'2364219',
'2419602',
'2467111',
'2860960',
'748294',
'751040',
'864978',
'877866',
'893005',
'1058304',
'1087745',
'1153549',
'2175174',
'2339284',
'2367187',
'2552605',
'2707315',
'2743068',
'2854187',
'741770',
'750198',
'862859',
'865887',
'880307',
'1022279',
'1066883',
'1154337',
'2389855',
'2427931',
'2450236',
'2592259',
'2717248',
'2757101',
'751278',
'754680',
'866465',
'1012723',
'1052575',
'1089095',
'1153195',
'2175675',
'2373129',
'2426894',
'2451362',
'751772',
'753667',
'866686',
'874285',
'894691',
'1011608',
'1052718',
'1078370',
'1151722',
'2228326',
'2261180',
'2375416',
'2404284',
'2553207',
'2703583',
'741880',
'755510',
'864263',
'865454',
'878948',
'894455',
'1018992',
'1029602',
'1065023',
'1154046',
'2433358',
'2444011',
'749714',
'761410',
'855679',
'863186',
'874498',
'1022802',
'1045150',
'1072418',
'2229726',
'2242335',
'2263240',
'2378523',
'2412978',
'2423697',
'2609098',
'2845334',
'2851618',
'765227',
'847233',
'882703',
'1054758',
'1088652',
'1151423',
'2121044',
'2161123',
'2577911',
'2758716',
'747030',
'762950',
'849496',
'867405',
'887605',
'887611',
'1015558',
'1077209',
'1153238',
'2174491',
'2228930',
'2397902',
'2502819',
'2553127',
'2733226',
'741838',
'755503',
'863173',
'865413',
'878777',
'895468',
'1066226',
'1073459',
'1154142',
'2442612',
'2549892',
'2677934',
'2861712',
'753646',
'763481',
'855440',
'859873',
'874940',
'885964',
'1024430',
'1071663',
'1075760',
'2185256',
'2411762',
'2432448',
'2605094',
'2666225',
'2819274',
'766587',
'846518',
'879066',
'882675',
'1027238',
'1054011',
'1150755',
'2162419',
'2440687',
'2465541',
'2577706',
'2703253',
'2865910',
'757014',
'854083',
'859386',
'878387',
'1024477',
'1043683',
'1070607',
'1080864',
'2124014',
'2426861',
'2447047',
'2727342',
'2818796',
'2860562',
'758629',
'852722',
'878731',
'880194',
'892421',
'1043866',
'1069220',
'1090385',
'2124274',
'2403170',
'2499108',
'2601546',
'2706314',
'2815566',
'842798',
'843887',
'863912',
'882300',
'894599',
'1027592',
'2165490',
'2309266',
'2403283',
'2499916',
'2597129',
'2805542',
'2807715',
'2808419',
'754123',
'840542',
'883310',
'1088016',
'1151546',
'2139829',
'2174947',
'2432712',
'2731725',
'2744844',
'760094',
'850382',
'867394',
'883989',
'1005039',
'1055278',
'1070797',
'1089853',
'2117173',
'2291368',
'2348924',
'2398732',
'2408448',
'2592077',
'2601615',
'2804950',
'839106',
'868188',
'1002553',
'1022276',
'1054070',
'1086686',
'1152314',
'2175608',
'2578411',
'2758750',
'749725',
'849513',
'866495',
'867930',
'877253',
'884343',
'1053859',
'1068239',
'1154952',
'2252101',
'2376097',
'2399152',
'2584705',
'2642226',
'2800080',
'837891',
'869195',
'1001243',
'1022459',
'1073725',
'1085954',
'1150176',
'1153313',
'2177018',
'2555323',
'2746802',
'741408',
'749588',
'862197',
'866166',
'879231',
'880449',
'891534',
'1066662',
'1154230',
'2257106',
'2385895',
'2403999',
'2579343',
'2785844',
'2799418',
'746344',
'843314',
'867689',
'883600',
'886932',
'1082702',
'1152501',
'2212705',
'2390051',
'2398366',
'2430026',
'2585181',
'2628796',
'2796825',
'742142',
'839869',
'869230',
'874438',
'890568',
'1024698',
'1086082',
'2179511',
'2429158',
'2668988',
'2756495',
'2859547',
'761399',
'848778',
'873634',
'878868',
'886559',
'1055375',
'1075246',
'1089079',
'1149607',
'2117491',
'2395524',
'2581688',
'2796983',
'2856748',
'742887',
'840070',
'868420',
'873655',
'889544',
'894645',
'1085851',
'1087714',
'2179043',
'2580380',
'2786468',
'2837141',
'745354',
'841652',
'867988',
'870723',
'886600',
'889601',
'1085828',
'1151609',
'2184357',
'2394475',
'2579855',
'2582133',
'2781555',
'746582',
'747987',
'842922',
'867761',
'883971',
'887596',
'1015288',
'1080045',
'2228850',
'2324539',
'2417633',
'2613642',
'2790943',
'2797688',
'2856010',
'761527',
'846736',
'882074',
'1026036',
'1041456',
'1055479',
'1068363',
'2118301',
'2149898',
'2412228',
'2494443',
'2693785',
'744003',
'756860',
'864371',
'875071',
'878375',
'1034977',
'1038137',
'1061841',
'1154062',
'2273060',
'2352501',
'753694',
'860159',
'863024',
'1023178',
'1085929',
'2586627',
'2685375',
'2771245',
'2358994',
'749568',
'855828',
'859596',
'1015102',
'1089467',
'1152386',
'2434280',
'2584179',
'2125388',
'2338808',
'750016',
'877847',
'882496',
'1088944',
'2413183',
'2433984',
'2777651',
'746567',
'767324',
'865504',
'892153',
'1028677',
'1081279',
'2554286',
'2757500',
'2780122',
'2239330',
'2332243',
'746777',
'768730',
'856479',
'858639',
'1153679',
'2607531',
'2727013',
'2223753',
'2375063',
'2394340',
'751186',
'859438',
'870940',
'1023258',
'2627396',
'2801467',
'2165401',
'743469',
'842779',
'869843',
'2397753',
'2605323',
'2701284',
'2771289',
'2805381',
'2173617',
'2363343',
'843101',
'870099',
'1080636',
'2100664',
'2400509',
'2406151',
'2708997',
'2160634',
'2387249',
'847643',
'870218',
'874079',
'1075701',
'1084870',
'2405343',
'2818707',
'2362046',
'749155',
'844324',
'868380',
'1084607',
'1149652',
'2440197',
'2745641',
'2823748',
'2341288',
'2359063',
'868394',
'869074',
'881466',
'1022525',
'1085304',
'2446672',
'2764690',
'2264150',
'2346615',
'753647',
'850245',
'856338',
'869562',
'1086372',
'1153030',
'2504991',
'2755962',
'2128325',
'2129406',
'2148911',
'2166048',
'2180854',
'2182286',
'2187748',
'2198569',
'2203691',
'2258174',
'2265004',
'2278588',
'2285360',
'2287863',
'2295395',
'2295556',
'2305796',
'2307231',
'2321694',
'2330855',
'2341698',
'2354137',
'2354672',
'2355902',
'2355946',
'2368689',
'2372026',
'2374164',
'2375030',
'2380402',
'2392100',
'2394328',
'2402578',
'2403103',
'2403341',
'2403363',
'2405695',
'2405822',
'2408119',
'2410099',
'2411089',
'2413321',
'2414981',
'2415879',
'2418850',
'2423334',
'2424994',
'2425735',
'2427839',
'2429443',
'2430958',
'2432950',
'2434689',
'2435474',
'2436055',
'2438616',
'2439434',
'2444237',
'2477226',
'2499518',
'2499745',
'2501852',
'2504731',
'2515379',
'2518203',
'2518895',
'2530312',
'2548948',
'2552661',
'2559021',
'2581871',
'2586536',
'2591429',
'2600215',
'2600306',
'2602718',
'2674145',
'2686343',
'2687322',
'2697288',
'2699122',
'2745399',
'2747734',
'2758135',
'2763586',
'2763600',
'2781602',
'2790384',
'2793991',
'2794856',
'2795620',
'2797336',
'2803573',
'2818536',
'2821289',
'2826821',
'2832088',
'2847427',
'2852414',
'2862063',
'740694',
'741425',
'741608',
'741884',
'742299',
'742700',
'743980',
'744897',
'745066',
'745339',
'746013',
'746021',
'746025',
'747338',
'747568',
'748543',
'748549',
'749404',
'749405',
'750190',
'750387',
'751149',
'752274',
'752351',
'752388',
'753307',
'754787',
'757013',
'757253',
'758006',
'758623',
'758814',
'758858',
'759103',
'759280',
'759463',
'760427',
'761498',
'762083',
'764062',
'764588',
'765032',
'765633',
'765644',
'766800',
'767020',
'767296',
'767298',
'767326',
'768314',
'837683',
'838421',
'841567',
'841601',
'842915',
'843338',
'844984',
'845378',
'847313',
'847364',
'847756',
'848774',
'849867',
'849892',
'853924',
'855590',
'862165',
'863527',
'864615',
'864704',
'864875',
'865674',
'866245',
'867219',
'867811',
'867875',
'868646',
'869113',
'869242',
'869385',
'869445',
'869689',
'869858',
'870045',
'870318',
'870630',
'870763',
'870887',
'871193',
'871525',
'872561',
'872976',
'873846',
'874400',
'874527',
'876266',
'876292',
'879148',
'879786',
'881062',
'881736',
'882104',
'884175',
'886037',
'887333',
'890822',
'891143',
'892299',
'893118',
'894380',
'1000890',
'1001531',
'1004345',
'1006795',
'1012257',
'1015698',
'1016318',
'1021247',
'1021322',
'1023432',
'1023588',
'1023892',
'1024780',
'1024864',
'1025148',
'1025768',
'1026381',
'1026437',
'1027054',
'1030785',
'1040622',
'1041219',
'1042938',
'1051623',
'1052631',
'1052906',
'1053875',
'1054304',
'1054497',
'1054506',
'1056205',
'1056306',
'1056569',
'1056685',
'1060609',
'1065704',
'1068173',
'1069408',
'1070759',
'1072974',
'1073061',
'1074185',
'1074196',
'1074868',
'1075220',
'1076500',
'1077050',
'1077772',
'1079086',
'1079297',
'1079958',
'1079960',
'1080395',
'1081022',
'1081023',
'1081345',
'1081598',
'1083640',
'1084228',
'1084253',
'1084356',
'1086704',
'1086829',
'1089062',
'1090258',
'1150420',
'1150476',
'1150894',
'1151133',
'1152366',
'1153057',
'1153121',
'1153631',
'1153693',
'1153711',
'1153783',
'1154210',
'1154442',
'1154694',
'2111667',
'2112997',
'2123353')

SELECT *,ROW_NUMBER () OVER (Partition By Loan_Nbr ORDER BY EXCP) AS 'RN'

INTO #FINAL2
FROM #FINAL

SELECT * FROM #FINAL2

ORDER BY EXCP

DROP TABLE #FINAL,#FINAL2
